(function () {
  "use strict";

  window.__WEB_TOOLBOX_LOADED__ = true;

  var WebToolbox = {};
  window.WebToolbox = WebToolbox;

  var UI_ID = "__web_toolbox_ui__v2";
  var LOG_ID = "__web_toolbox_log__v2";

  function el(tag) {
    return document.createElement(tag);
  }

  function setStyles(node, pairs) {
    for (var i = 0; i < pairs.length; i++) {
      node.style[pairs[i][0]] = pairs[i][1];
    }
  }

  function safeText(v) {
    return typeof v === "string" ? v : JSON.stringify(v, null, 2);
  }

  function nowIso() {
    return new Date().toISOString();
  }

  function downloadText(filename, content) {
    var blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    var url = URL.createObjectURL(blob);
    var a = el("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(function () {
      URL.revokeObjectURL(url);
    }, 5000);
  }

  async function copyText(str) {
    try {
      await navigator.clipboard.writeText(str);
      return true;
    } catch (_) {
      try {
        var ta = el("textarea");
        ta.value = str;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        var ok = document.execCommand("copy");
        ta.remove();
        return ok;
      } catch (_) {
        return false;
      }
    }
  }

  function log(msg) {
    var box = document.getElementById(LOG_ID);
    if (!box) return;
    box.value += "[" + nowIso() + "] " + msg + "\n";
    box.scrollTop = box.scrollHeight;
  }

  function setOutput(value) {
    var box = document.getElementById(LOG_ID);
    if (!box) return;
    box.value = String(value || "");
    box.scrollTop = 0;
  }

  // ---------------------------
  // Tool: Visible Text
  // ---------------------------
  function getVisibleText() {
    return (document.body && document.body.innerText) || document.documentElement.innerText || "";
  }

  // ---------------------------
  // Tool: DOM HTML
  // ---------------------------
  function getDomHtml() {
    return "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
  }

  function prettyHtml(html) {
    html = String(html || "");
    html = html.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    html = html.replace(/>\s+</g, "><");

    var out = [];
    var indent = 0;

    var tokens = html.split(/(<[^>]+>)/g).filter(function (x) {
      return x !== "";
    });

    for (var i = 0; i < tokens.length; i++) {
      var tok = tokens[i];

      if (tok.startsWith("<")) {
        var isComment = /^<!--/.test(tok);
        var isDoctype = /^<!DOCTYPE/i.test(tok);
        var isClosing = /^<\//.test(tok);
        var isSelfClosing =
          /\/>$/.test(tok) ||
          /^<(!|meta|link|br|hr|img|input|source|area|base|col|embed|param|track|wbr)\b/i.test(tok);

        if (isClosing) {
          indent = Math.max(0, indent - 1);
        }

        out.push("  ".repeat(indent) + tok);

        if (!isClosing && !isSelfClosing && !isComment && !isDoctype) {
          indent++;
        }
      } else {
        var txt = tok.replace(/\s+/g, " ").trim();
        if (txt) out.push("  ".repeat(indent) + txt);
      }
    }

    return out.join("\n");
  }

  // ---------------------------
  // Tool: Server HTML (raw response)
  // ---------------------------
  async function fetchServerHtml() {
    var res = await fetch(location.href, { method: "GET", credentials: "include", cache: "no-store" });
    var txt = await res.text();
    return {
      ok: res.ok,
      status: res.status,
      contentType: (res.headers.get("content-type") || "").toLowerCase(),
      body: txt,
    };
  }

  // ---------------------------
  // Tool: Metadata Inspector
  // ---------------------------
  function extractMetadata() {
    var out = {};
    out.url = location.href;
    out.title = document.title || "";
    out.meta = [];

    var metas = Array.from(document.querySelectorAll("meta"));
    for (var i = 0; i < metas.length; i++) {
      var m = metas[i];
      var name = m.getAttribute("name");
      var prop = m.getAttribute("property");
      var content = m.getAttribute("content");
      if (!content) continue;
      out.meta.push({ name: name || null, property: prop || null, content: content });
    }

    var canonical = document.querySelector('link[rel="canonical"]');
    out.canonical = canonical ? canonical.getAttribute("href") : null;

    var jsonLd = Array.from(document.querySelectorAll('script[type="application/ld+json"]')).map(function (s) {
      return s.textContent || "";
    });
    out.jsonLd = jsonLd;

    return out;
  }

  // ---------------------------
  // Tool: Links / Headings / Forms / Images
  // ---------------------------
  function extractStructure() {
    var links = Array.from(document.querySelectorAll("a[href]")).map(function (a) {
      return {
        text: (a.innerText || "").trim(),
        href: a.href,
      };
    });

    var headings = Array.from(document.querySelectorAll("h1,h2,h3,h4,h5,h6")).map(function (h) {
      return {
        tag: h.tagName,
        text: (h.innerText || "").trim(),
      };
    });

    var images = Array.from(document.querySelectorAll("img")).map(function (img) {
      return {
        src: img.currentSrc || img.src || null,
        alt: img.alt || "",
        naturalWidth: img.naturalWidth || 0,
        naturalHeight: img.naturalHeight || 0,
      };
    });

    var forms = Array.from(document.querySelectorAll("form")).map(function (f) {
      var inputs = Array.from(f.querySelectorAll("input,textarea,select")).map(function (i) {
        return {
          tag: i.tagName,
          type: i.getAttribute("type") || null,
          name: i.getAttribute("name") || null,
          id: i.id || null,
        };
      });
      return {
        action: f.getAttribute("action") || null,
        method: (f.getAttribute("method") || "GET").toUpperCase(),
        inputs: inputs,
      };
    });

    return { links: links, headings: headings, images: images, forms: forms };
  }

  // ---------------------------
  // Tool: Asset Lister (CSS/JS/fonts/media)
  // ---------------------------
  function listAssets() {
    var scripts = Array.from(document.querySelectorAll("script[src]")).map(function (s) {
      return s.src;
    });

    var css = Array.from(document.querySelectorAll('link[rel="stylesheet"][href]')).map(function (l) {
      return l.href;
    });

    var preload = Array.from(document.querySelectorAll('link[rel="preload"][href]')).map(function (l) {
      return { href: l.href, as: l.getAttribute("as") || null };
    });

    var media = Array.from(document.querySelectorAll("audio,video,source"))
      .map(function (m) {
        return m.src || m.getAttribute("src") || null;
      })
      .filter(Boolean);

    return { scripts: scripts, stylesheets: css, preload: preload, media: media };
  }

  // ---------------------------
  // Tool: CSS Background Images
  // ---------------------------
  function extractBackgroundImages(limit) {
    limit = typeof limit === "number" ? limit : 5000;
    var urls = new Set();

    var nodes = Array.from(document.querySelectorAll("*"));
    for (var i = 0; i < nodes.length && i < limit; i++) {
      var cs = getComputedStyle(nodes[i]);
      var bg = cs.backgroundImage || "";
      if (!bg || bg === "none") continue;

      var re = /url\(["']?([^"')]+)["']?\)/g;
      var match;
      while ((match = re.exec(bg))) {
        urls.add(match[1]);
      }
    }
    return Array.from(urls);
  }

  // ---------------------------
  // Tool: Videos
  // ---------------------------
  function extractVideos() {
    var vids = Array.from(document.querySelectorAll("video")).map(function (v) {
      var sources = Array.from(v.querySelectorAll("source"))
        .map(function (s) {
          return s.src || s.getAttribute("src") || null;
        })
        .filter(Boolean);

      return { src: v.src || v.getAttribute("src") || null, sources: sources };
    });
    return vids;
  }

  // ---------------------------
  // Tool: Trackers (third-party domains)
  // ---------------------------
  function detectThirdPartyDomains() {
    function origin(u) {
      try {
        return new URL(u, location.href).origin;
      } catch (_) {
        return null;
      }
    }

    var own = location.origin;
    var domains = new Set();

    var candidates = [];
    Array.from(document.querySelectorAll("script[src],link[href],img[src],iframe[src],source[src],video[src],audio[src]")).forEach(function (n) {
      candidates.push(n.src || n.href || n.getAttribute("src") || n.getAttribute("href"));
    });

    for (var i = 0; i < candidates.length; i++) {
      var u = candidates[i];
      if (!u) continue;
      var o = origin(u);
      if (!o) continue;
      if (o !== own) domains.add(o);
    }

    return Array.from(domains).sort();
  }

  // ---------------------------
  // Tool: Word Frequency
  // ---------------------------
  function wordFrequency(topN) {
    topN = typeof topN === "number" ? topN : 30;

    var txt = getVisibleText().toLowerCase();
    txt = txt.replace(/[^\p{L}\p{N}\s]+/gu, " ");

    var parts = txt.split(/\s+/g).filter(Boolean);
    var map = Object.create(null);

    for (var i = 0; i < parts.length; i++) {
      var w = parts[i];
      if (w.length < 3) continue;
      map[w] = (map[w] || 0) + 1;
    }

    var arr = Object.keys(map).map(function (k) {
      return { word: k, count: map[k] };
    });

    arr.sort(function (a, b) {
      return b.count - a.count;
    });

    return arr.slice(0, topN);
  }

  // ---------------------------
  // Tool: Basic SEO Checks
  // ---------------------------
  function seoCheck() {
    var h1 = document.querySelectorAll("h1").length;
    var title = document.title || "";
    var desc = document.querySelector('meta[name="description"]');
    var canonical = document.querySelector('link[rel="canonical"]');

    var imgs = Array.from(document.querySelectorAll("img"));
    var missingAlt = imgs.filter(function (i) {
      return !i.alt || !i.alt.trim();
    }).length;

    return {
      titleLength: title.length,
      h1Count: h1,
      hasMetaDescription: !!desc,
      metaDescriptionLength: desc ? (desc.getAttribute("content") || "").length : 0,
      hasCanonical: !!canonical,
      images: imgs.length,
      imagesMissingAlt: missingAlt,
    };
  }

  // ---------------------------
  // Tool: Basic Accessibility Checks
  // ---------------------------
  function a11yCheck() {
    var buttons = Array.from(document.querySelectorAll("button"));
    var emptyButtons = buttons.filter(function (b) {
      var t = (b.innerText || "").trim();
      var aria = (b.getAttribute("aria-label") || "").trim();
      return !t && !aria;
    }).length;

    var inputs = Array.from(document.querySelectorAll("input,textarea,select"));
    var unlabeled = inputs.filter(function (i) {
      var id = i.id;
      var aria = (i.getAttribute("aria-label") || "").trim();
      if (aria) return false;
      if (id && document.querySelector('label[for="' + CSS.escape(id) + '"]')) return false;

      var parent = i.parentElement;
      while (parent) {
        if (parent.tagName === "LABEL") return false;
        parent = parent.parentElement;
      }
      return true;
    }).length;

    return { emptyButtons: emptyButtons, unlabeledInputs: unlabeled, inputs: inputs.length, buttons: buttons.length };
  }

  // ---------------------------
  // Tool: Reading Mode Toggle
  // ---------------------------
  function toggleReadingMode() {
    var id = "__web_toolbox_reading_css__";
    var existing = document.getElementById(id);
    if (existing) {
      existing.remove();
      return false;
    }

    var style = el("style");
    style.id = id;
    style.textContent =
      "header,nav,footer,aside,[role=banner],[role=navigation],[role=contentinfo],.ads,.ad,.cookie,.consent,.popup{display:none !important;}" +
      "body{max-width:900px !important;margin:0 auto !important;padding:24px !important;line-height:1.6 !important;}";
    document.documentElement.appendChild(style);
    return true;
  }

  // ---------------------------
  // Tool: Dark Mode Toggle
  // ---------------------------
  function toggleDarkMode() {
    var id = "__web_toolbox_dark_css__";
    var existing = document.getElementById(id);
    if (existing) {
      existing.remove();
      return false;
    }

    var style = el("style");
    style.id = id;
    style.textContent =
      "html{filter:invert(1) hue-rotate(180deg) !important;background:#000 !important;}" +
      "img,video,iframe{filter:invert(1) hue-rotate(180deg) !important;}";
    document.documentElement.appendChild(style);
    return true;
  }

  // ---------------------------
  // Tool: Auto Expand “Show more”
  // ---------------------------
  function autoExpand() {
    var labels = ["show more", "read more", "more", "expand", "see more"];
    var clicked = 0;

    var buttons = Array.from(document.querySelectorAll("button,a,[role=button]"));
    for (var i = 0; i < buttons.length; i++) {
      var t = (buttons[i].innerText || "").toLowerCase().trim();
      if (!t) continue;

      for (var j = 0; j < labels.length; j++) {
        if (t === labels[j] || t.includes(labels[j])) {
          try {
            buttons[i].click();
            clicked++;
          } catch (_) {}
          break;
        }
      }
    }

    return clicked;
  }

  // ---------------------------
  // Tool: Auto Scroll to load lazy content
  // ---------------------------
  async function autoScroll(seconds) {
    seconds = typeof seconds === "number" ? seconds : 10;
    var end = Date.now() + seconds * 1000;
    var steps = 0;

    while (Date.now() < end) {
      window.scrollBy(0, Math.max(300, Math.floor(window.innerHeight * 0.8)));
      steps++;
      await new Promise(function (r) {
        setTimeout(r, 300);
      });
    }

    return steps;
  }

  // ---------------------------
  // Tool: Fetch/XHR Sniffer (basic)
  // ---------------------------
  function enableSniffer() {
    if (window.__WEB_TOOLBOX_SNIFF__) return false;
    window.__WEB_TOOLBOX_SNIFF__ = true;

    var origFetch = window.fetch;
    window.fetch = async function () {
      var url = arguments[0];
      try {
        log("fetch -> " + String(url));
      } catch (_) {}
      return origFetch.apply(this, arguments);
    };

    var origOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function (method, url) {
      try {
        log("xhr -> " + method + " " + String(url));
      } catch (_) {}
      return origOpen.apply(this, arguments);
    };

    return true;
  }

  // ---------------------------
  // Tool: IP Extractor (from page text)
  // ---------------------------
  function extractIpsFromPageText() {
    var text = getVisibleText();

    // IPv4: 0.0.0.0 - 255.255.255.255 (basic strict-ish)
    var ipv4Re = /\b(?:(?:25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|1?\d?\d)\b/g;

    // IPv6: best-effort (covers full + compressed)
    // Not a full RFC parser, but good for text scanning.
    var ipv6Re =
      /\b(?:[A-F0-9]{1,4}:){7}[A-F0-9]{1,4}\b|\b(?:[A-F0-9]{1,4}:){1,7}:\b|\b:(?::[A-F0-9]{1,4}){1,7}\b|\b(?:[A-F0-9]{1,4}:){1,6}:[A-F0-9]{1,4}\b|\b(?:[A-F0-9]{1,4}:){1,5}(?::[A-F0-9]{1,4}){1,2}\b|\b(?:[A-F0-9]{1,4}:){1,4}(?::[A-F0-9]{1,4}){1,3}\b|\b(?:[A-F0-9]{1,4}:){1,3}(?::[A-F0-9]{1,4}){1,4}\b|\b(?:[A-F0-9]{1,4}:){1,2}(?::[A-F0-9]{1,4}){1,5}\b|\b[A-F0-9]{1,4}:(?::[A-F0-9]{1,4}){1,6}\b/gi;

    var ipv4 = text.match(ipv4Re) || [];
    var ipv6 = text.match(ipv6Re) || [];

    // Normalize / de-dup
    var set4 = new Set();
    for (var i = 0; i < ipv4.length; i++) set4.add(ipv4[i]);

    var set6 = new Set();
    for (var j = 0; j < ipv6.length; j++) {
      var v = String(ipv6[j]).toLowerCase();
      set6.add(v);
    }

    // Remove obvious false positives where IPv6 regex matches lone ":" patterns etc.
    // Keep only strings that contain at least one ":" and at least one hex digit.
    var filtered6 = Array.from(set6).filter(function (x) {
      return x.indexOf(":") !== -1 && /[0-9a-f]/i.test(x);
    });

    filtered6.sort();
    var out4 = Array.from(set4);
    out4.sort();

    return {
      ipv4Count: out4.length,
      ipv6Count: filtered6.length,
      ipv4: out4,
      ipv6: filtered6,
    };
  }

  // ---------------------------
  // UI
  // ---------------------------
  function openUi() {
    var existing = document.getElementById(UI_ID);
    if (existing) return;

    // Root
    var wrap = el("div");
    wrap.id = UI_ID;

    setStyles(wrap, [
      ["position", "fixed"],
      ["right", "16px"],
      ["bottom", "16px"],
      ["zIndex", "2147483647"],
      ["width", "460px"],
      ["fontFamily", "Arial, sans-serif"],
      ["background", "rgba(18,18,18,0.94)"],
      ["color", "#fff"],
      ["border", "1px solid rgba(255,255,255,0.14)"],
      ["borderRadius", "14px"],
      ["boxShadow", "0 14px 36px rgba(0,0,0,0.45)"],
      ["padding", "12px"],
      ["backdropFilter", "blur(6px)"],
    ]);

    // Header
    var top = el("div");
    setStyles(top, [
      ["display", "flex"],
      ["alignItems", "center"],
      ["justifyContent", "space-between"],
      ["gap", "10px"],
    ]);

    var titleWrap = el("div");
    setStyles(titleWrap, [["display", "flex"], ["flexDirection", "column"], ["gap", "2px"]]);

    var title = el("div");
    title.textContent = "Web Toolbox";
    setStyles(title, [["fontWeight", "900"], ["fontSize", "14px"], ["letterSpacing", "0.2px"]]);

    var sub = el("div");
    sub.textContent = "Inspect • extract • copy • download";
    setStyles(sub, [["fontSize", "11px"], ["opacity", "0.72"]]);

    titleWrap.appendChild(title);
    titleWrap.appendChild(sub);

    var close = el("button");
    close.type = "button";
    close.textContent = "×";
    setStyles(close, [
      ["cursor", "pointer"],
      ["width", "30px"],
      ["height", "30px"],
      ["borderRadius", "999px"],
      ["border", "1px solid rgba(255,255,255,0.18)"],
      ["background", "rgba(255,255,255,0.08)"],
      ["color", "#fff"],
      ["fontSize", "18px"],
      ["fontWeight", "900"],
      ["lineHeight", "1"],
    ]);
    close.addEventListener("click", function () {
      wrap.remove();
    });

    top.appendChild(titleWrap);
    top.appendChild(close);

    // Buttons grid
    var grid = el("div");
    setStyles(grid, [
      ["display", "grid"],
      ["gridTemplateColumns", "1fr 1fr"],
      ["gap", "8px"],
      ["marginTop", "10px"],
    ]);

    function mkBtn(label, onClick, variant) {
      var b = el("button");
      b.type = "button";
      b.textContent = label;

      var bg = "rgba(255,255,255,0.10)";
      var border = "1px solid rgba(255,255,255,0.16)";
      if (variant === "secondary") {
        bg = "rgba(255,255,255,0.06)";
        border = "1px solid rgba(255,255,255,0.12)";
      }

      setStyles(b, [
        ["cursor", "pointer"],
        ["padding", "10px 10px"],
        ["borderRadius", "10px"],
        ["border", border],
        ["background", bg],
        ["color", "#fff"],
        ["fontSize", "12px"],
        ["fontWeight", "800"],
        ["textAlign", "left"],
        ["transition", "transform 80ms ease, background 120ms ease, border-color 120ms ease"],
      ]);

      b.addEventListener("mouseenter", function () {
        b.style.background = "rgba(255,255,255,0.14)";
        b.style.borderColor = "rgba(255,255,255,0.22)";
      });
      b.addEventListener("mouseleave", function () {
        b.style.background = bg;
        b.style.borderColor = border.replace("1px solid ", "");
        b.style.border = border;
      });
      b.addEventListener("mousedown", function () {
        b.style.transform = "scale(0.99)";
      });
      b.addEventListener("mouseup", function () {
        b.style.transform = "scale(1)";
      });

      b.addEventListener("click", onClick);
      return b;
    }

    // Output textarea
    var output = el("textarea");
    output.id = LOG_ID;
    output.readOnly = true;
    setStyles(output, [
      ["width", "100%"],
      ["height", "190px"],
      ["marginTop", "10px"],
      ["padding", "10px 10px"],
      ["borderRadius", "12px"],
      ["border", "1px solid rgba(255,255,255,0.12)"],
      ["background", "rgba(0,0,0,0.28)"],
      ["color", "#fff"],
      ["fontSize", "12px"],
      ["resize", "vertical"],
      ["whiteSpace", "pre"],
      ["fontFamily", "Consolas, Menlo, Monaco, monospace"],
      ["outline", "none"],
    ]);
    output.value = "Ready.\n";

    // Actions row (secondary)
    var actions = el("div");
    setStyles(actions, [
      ["display", "grid"],
      ["gridTemplateColumns", "1fr 1fr"],
      ["gap", "8px"],
      ["marginTop", "8px"],
    ]);

    var btnCopy = mkBtn(
      "Copy output",
      async function () {
        var ok = await copyText(output.value);
        log(ok ? "Copied output." : "Copy blocked.");
      },
      "secondary"
    );

    var btnDownload = mkBtn(
      "Download output",
      function () {
        downloadText("web_toolbox_output_" + Date.now() + ".txt", output.value);
        log("Downloaded output.");
      },
      "secondary"
    );

    actions.appendChild(btnCopy);
    actions.appendChild(btnDownload);

    // Tools
    grid.appendChild(
      mkBtn("Copy Visible Text", async function () {
        var t = getVisibleText();
        setOutput(t);
        var ok = await copyText(t);
        log(ok ? "Copied visible text (" + t.length + " chars)." : "Copy blocked.");
      })
    );

    grid.appendChild(
      mkBtn("Copy DOM HTML", async function () {
        var h = getDomHtml();
        setOutput(h);
        var ok = await copyText(h);
        log(ok ? "Copied DOM HTML (" + h.length + " chars)." : "Copy blocked.");
      })
    );

    grid.appendChild(
      mkBtn("Copy DOM HTML (Pretty)", async function () {
        var h = prettyHtml(getDomHtml());
        setOutput(h);
        var ok = await copyText(h);
        log(ok ? "Copied pretty DOM HTML (" + h.length + " chars)." : "Copy blocked.");
      })
    );

    grid.appendChild(
      mkBtn("Copy Server HTML", async function () {
        log("Fetching server HTML...");
        var r = await fetchServerHtml();
        setOutput(r.body);
        var ok = await copyText(r.body);
        log(ok ? "Copied server HTML (" + r.body.length + " chars). status=" + r.status : "Copy blocked.");
      })
    );

    grid.appendChild(
      mkBtn("Metadata (JSON)", function () {
        var m = extractMetadata();
        setOutput(safeText(m));
        log("Extracted metadata.");
      })
    );

    grid.appendChild(
      mkBtn("Structure (links/images/forms)", function () {
        var s = extractStructure();
        setOutput(safeText(s));
        log("Extracted structure.");
      })
    );

    grid.appendChild(
      mkBtn("Assets (css/js/media)", function () {
        var a = listAssets();
        setOutput(safeText(a));
        log("Listed assets.");
      })
    );

    grid.appendChild(
      mkBtn("Background Images", function () {
        var b = extractBackgroundImages();
        setOutput(safeText({ count: b.length, urls: b }));
        log("Extracted background images: " + b.length);
      })
    );

    grid.appendChild(
      mkBtn("Videos (sources)", function () {
        var v = extractVideos();
        setOutput(safeText(v));
        log("Extracted videos.");
      })
    );

    grid.appendChild(
      mkBtn("Trackers (3rd-party domains)", function () {
        var d = detectThirdPartyDomains();
        setOutput(safeText({ count: d.length, domains: d }));
        log("Detected third-party domains: " + d.length);
      })
    );

    grid.appendChild(
      mkBtn("Word Frequency (top 30)", function () {
        var w = wordFrequency(30);
        setOutput(safeText(w));
        log("Computed word frequency.");
      })
    );

    grid.appendChild(
      mkBtn("SEO Check", function () {
        var s = seoCheck();
        setOutput(safeText(s));
        log("Ran SEO checks.");
      })
    );

    grid.appendChild(
      mkBtn("A11y Check", function () {
        var a = a11yCheck();
        setOutput(safeText(a));
        log("Ran accessibility checks.");
      })
    );

    grid.appendChild(
      mkBtn("Extract IPs (from page text)", function () {
        var ips = extractIpsFromPageText();
        setOutput(safeText(ips));
        log("Extracted IPs. IPv4=" + ips.ipv4Count + " IPv6=" + ips.ipv6Count);
      })
    );

    grid.appendChild(
      mkBtn("Toggle Reading Mode", function () {
        var on = toggleReadingMode();
        log(on ? "Reading mode ON." : "Reading mode OFF.");
      })
    );

    grid.appendChild(
      mkBtn("Toggle Dark Mode", function () {
        var on = toggleDarkMode();
        log(on ? "Dark mode ON." : "Dark mode OFF.");
      })
    );

    grid.appendChild(
      mkBtn("Auto Expand (Show more)", function () {
        var n = autoExpand();
        log("Auto expand clicked: " + n);
      })
    );

    grid.appendChild(
      mkBtn("Auto Scroll (10s)", async function () {
        log("Auto scroll start (10s)...");
        var steps = await autoScroll(10);
        log("Auto scroll done. steps=" + steps);
      })
    );

    grid.appendChild(
      mkBtn("Enable API Sniffer", function () {
        var on = enableSniffer();
        log(on ? "Sniffer enabled (logs fetch/xhr)." : "Sniffer already enabled.");
      })
    );

    grid.appendChild(
      mkBtn("Close Toolbox", function () {
        wrap.remove();
      })
    );

    wrap.appendChild(top);
    wrap.appendChild(grid);
    wrap.appendChild(actions);
    wrap.appendChild(output);

    document.documentElement.appendChild(wrap);
  }

  WebToolbox.open = openUi;

  // Auto-open on load
  openUi();
})();
