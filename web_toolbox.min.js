(function () {
  "use strict";

  window.__WEB_TOOLBOX_LOADED__ = true;

  var WebToolbox = {};
  window.WebToolbox = WebToolbox;

  var UI_ID = "__web_toolbox_ui__v2";
  var LOG_ID = "__web_toolbox_log__v2";

  function el(tag) {
    return document.createElement(tag);
  }

  function setStyles(node, pairs) {
    for (var i = 0; i < pairs.length; i++) {
      node.style[pairs[i][0]] = pairs[i][1];
    }
  }

  function safeText(v) {
    return typeof v === "string" ? v : JSON.stringify(v, null, 2);
  }

  function nowIso() {
    return new Date().toISOString();
  }

  function downloadText(filename, content) {
    var blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    var url = URL.createObjectURL(blob);
    var a = el("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(function () {
      URL.revokeObjectURL(url);
    }, 5000);
  }

  async function purgeJsDelivrCache() {
    var purgeUrl =
      "https://purge.jsdelivr.net/gh/InteractionSystem/web-toolbox@main/web_toolbox.min.js";
    try {
      window.open(purgeUrl, "_blank", "noopener,noreferrer");
      return true;
    } catch (_) {
      return false;
    }
  }

  async function copyText(str) {
    try {
      await navigator.clipboard.writeText(str);
      return true;
    } catch (_) {
      try {
        var ta = el("textarea");
        ta.value = str;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        var ok = document.execCommand("copy");
        ta.remove();
        return ok;
      } catch (_) {
        return false;
      }
    }
  }

  function log(msg) {
    var box = document.getElementById(LOG_ID);
    if (!box) return;
    box.value += "[" + nowIso() + "] " + msg + "\n";
    box.scrollTop = box.scrollHeight;
  }

  function getVisibleText() {
    return (
      (document.body && document.body.innerText) ||
      document.documentElement.innerText ||
      ""
    );
  }

  function extractIpAddresses() {
    var text = getVisibleText();
    var ipv4 =
      /\b((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(?=\d)|$)){4}\b/g;
    var ipv6 =
      /\b([0-9a-fA-F]{1,4}:){2,7}[0-9a-fA-F]{1,4}\b/g;

    var matches = new Set();
    var m;

    while ((m = ipv4.exec(text))) matches.add(m[0]);
    while ((m = ipv6.exec(text))) matches.add(m[0]);

    return Array.from(matches).sort();
  }

  function openUi() {
    if (document.getElementById(UI_ID)) return;

    var wrap = el("div");
    wrap.id = UI_ID;

    setStyles(wrap, [
      ["position", "fixed"],
      ["right", "18px"],
      ["bottom", "18px"],
      ["zIndex", "2147483647"],
      ["width", "460px"],
      ["fontFamily", "system-ui, -apple-system, Segoe UI, Roboto, sans-serif"],
      ["background", "rgba(22,22,22,0.96)"],
      ["color", "#f5f5f5"],
      ["border", "1px solid rgba(255,255,255,0.08)"],
      ["borderRadius", "14px"],
      ["boxShadow", "0 15px 40px rgba(0,0,0,0.4)"],
      ["padding", "14px"],
    ]);

    var top = el("div");
    setStyles(top, [
      ["display", "flex"],
      ["justifyContent", "space-between"],
      ["alignItems", "center"],
      ["marginBottom", "10px"],
      ["borderBottom", "1px solid rgba(255,255,255,0.08)"],
      ["paddingBottom", "8px"],
    ]);

    var title = el("div");
    title.textContent = "Web Toolbox";
    setStyles(title, [["fontWeight", "700"], ["fontSize", "15px"]]);

    var close = el("button");
    close.textContent = "Ã—";
    setStyles(close, [
      ["cursor", "pointer"],
      ["background", "transparent"],
      ["border", "none"],
      ["color", "#aaa"],
      ["fontSize", "18px"],
    ]);
    close.onclick = function () {
      wrap.remove();
    };

    top.appendChild(title);
    top.appendChild(close);

    var grid = el("div");
    setStyles(grid, [
      ["display", "grid"],
      ["gridTemplateColumns", "1fr 1fr"],
      ["gap", "8px"],
      ["marginTop", "8px"],
    ]);

    function mkBtn(label, fn) {
      var b = el("button");
      b.textContent = label;
      setStyles(b, [
        ["cursor", "pointer"],
        ["padding", "9px"],
        ["borderRadius", "8px"],
        ["border", "1px solid rgba(255,255,255,0.08)"],
        ["background", "rgba(255,255,255,0.06)"],
        ["color", "#f5f5f5"],
        ["fontSize", "12px"],
      ]);
      b.onmouseenter = function () {
        b.style.background = "rgba(255,255,255,0.12)";
      };
      b.onmouseleave = function () {
        b.style.background = "rgba(255,255,255,0.06)";
      };
      b.onclick = fn;
      return b;
    }

    var output = el("textarea");
    output.id = LOG_ID;
    output.readOnly = true;
    setStyles(output, [
      ["width", "100%"],
      ["height", "200px"],
      ["marginTop", "12px"],
      ["padding", "10px"],
      ["borderRadius", "8px"],
      ["border", "1px solid rgba(255,255,255,0.08)"],
      ["background", "#111"],
      ["color", "#ddd"],
      ["fontSize", "12px"],
      ["resize", "vertical"],
    ]);
    output.value = "Ready.\n";

    grid.appendChild(
      mkBtn("Extract IP Addresses", function () {
        var ips = extractIpAddresses();
        output.value = ips.length
          ? ips.join("\n")
          : "No IP addresses found.";
        log("IP scan complete. Found: " + ips.length);
      })
    );

    grid.appendChild(
      mkBtn("Copy Visible Text", async function () {
        var t = getVisibleText();
        output.value = t;
        await copyText(t);
        log("Copied visible text.");
      })
    );

    grid.appendChild(
      mkBtn("Purge jsDelivr Cache", function () {
        var ok = purgeJsDelivrCache();
        log(ok ? "Opened purge tab." : "Popup blocked.");
      })
    );

    grid.appendChild(
      mkBtn("Close Toolbox", function () {
        wrap.remove();
      })
    );

    wrap.appendChild(top);
    wrap.appendChild(grid);
    wrap.appendChild(output);
    document.documentElement.appendChild(wrap);
  }

  WebToolbox.open = openUi;
  openUi();
})();
